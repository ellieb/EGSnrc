<!DOCTYPE html>
<html>
  <head>
    <title>Dose Viewer</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://x3dom.org/download/dev/x3dom-full.js"></script>
    <link rel="stylesheet" href="https://x3dom.org/release/x3dom.css" />
    <link rel="stylesheet" href="styles.css" />
    <script src="https://raw.githack.com/jamesleesaunders/d3-x3d/master/dist/d3-x3d.js"></script>
  </head>
  <body>
    <h1>Dose Viewer</h1>
    <p>Upload .egsphant and .3ddose files.</p>
    <input type="file" id="file-input" />
    <button id="read-button">Read File</button>
    <div id="dose-viewer-container">
      <form>
        <input type="radio" id="xy" name="axis" value="xy" checked />
        <label for="xy">xy</label>
        <input type="radio" id="yz" name="axis" value="yz" />
        <label for="yz">yz</label>
        <input type="radio" id="xz" name="axis" value="xz" />
        <label for="xz">xz</label>
      </form>
      <div class="slider-container">
        <label for="slice-number"
          >Slice Number:
          <output type="text" id="slider-value" value="">0</output>
        </label>
        <br />
        <output type="text" id="slider-min" value="">0</output>
        <input
          type="range"
          id="slider-range"
          min="0"
          max="100"
          value="0"
          class="slider"
          disabled
        />
        <output type="text" id="slider-max" value=""></output>
      </div>
      <div id="chartholder">
        <svg id="axis-svg" class="plot"></svg>
        <canvas id="plot-canvas" class="plot"></canvas>
        <svg id="plot-svg" class="plot"></svg>
      </div>
    </div>

    <script type="text/javascript" src="./create-volume.js"></script>
    <script>
      // TODO: Make a dose-view options class?
      // TODO: Move all javascript outside of index.html
      // TODO: Add button to increment/decrement slider by 1

      // Define all size variables
      var fullWidth = 500;
      var fullHeight = 500;
      var margin = { top: 10, right: 10, bottom: 30, left: 30 };
      var width = fullWidth - margin.left - margin.right;
      var height = fullHeight - margin.top - margin.bottom;

      var sliceNum = d3.select("#slider-value").node().value;
      var axis = d3.selectAll("input[name='axis']:checked").node().value;
      var canvas = d3
        .select("#plot-canvas")
        .attr("height", height)
        .attr("width", width)
        .style(
          "transform",
          "translate(" + margin.left + "px" + "," + margin.top + "px" + ")"
        );

      var svgPlot = d3
        .select("#plot-svg")
        .attr("width", height)
        .attr("height", height)
        .style(
          "transform",
          "translate(" + margin.left + "px" + "," + margin.top + "px" + ")"
        );

      var svgAxis = d3
        .select("#axis-svg")
        .attr("width", fullWidth)
        .attr("height", fullHeight)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      //TODO: Make a list of volumes rather than have one global
      const densityVol = new DensityVolume(height, width);
      const doseVol = new DoseVolume(height, width);

      const slider = d3.select("#slider-range").on("change", function () {
        // Update slider text
        d3.select("#slider-value").node().value = this.value;
        sliceNum = parseInt(this.value);

        // Update image if densityVol data and/or doseVol data exists
        let slice;
        let context;
        if (Object.keys(densityVol.data).length > 0) {
          slice = densityVol.getSlice(axis, sliceNum);
          context = densityVol.getSliceImageContext(slice, canvas);
        }
        if (Object.keys(doseVol.data).length > 0) {
          slice = doseVol.getSlice(axis, sliceNum);
          context = doseVol.getSliceImageContext(slice, svgPlot);
        }
      });

      const buttons = d3
        .selectAll("input[name='axis']")
        .on("change", function () {
          axis = this.value;
          // Update image if densityVol data and/or doseVol data exists
          let slice;
          let context;
          if (Object.keys(densityVol.data).length > 0) {
            slice = densityVol.getSlice(axis, sliceNum);
            context = densityVol.getSliceImageContext(slice, canvas);
            updateSlider(slice);
          }
          if (Object.keys(doseVol.data).length > 0) {
            slice = doseVol.getSlice(axis, sliceNum);
            context = doseVol.getSliceImageContext(slice, svgPlot);
          }
        });

      function updateSlider(slice) {
        let sliderRange = d3.select("#slider-range").node();

        // Enable slider if disabled
        if (sliderRange.disabled) sliderRange.disabled = false;

        // Change max slider value to max number of slices
        if (sliceNum >= slice.totalSlices) {
          d3.select("#slider-value").node().value = slice.totalSlices - 1;
        }
        sliderRange.max = slice.totalSlices - 1;
        d3.select("#slider-max").node().value = slice.totalSlices - 1;
      }
    </script>
    <script type="text/javascript" src="./read-data.js"></script>
  </body>
</html>
