<!DOCTYPE html>
<html>
  <head>
    <title>Dose Viewer</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://x3dom.org/download/dev/x3dom-full.js"></script>
    <link rel="stylesheet" href="https://x3dom.org/release/x3dom.css" />
    <link rel="stylesheet" href="styles.css" />
    <script src="https://raw.githack.com/jamesleesaunders/d3-x3d/master/dist/d3-x3d.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.js"></script>
  </head>
  <body>
    <h1>Dose Viewer</h1>
    <p>Upload .egsphant and .3ddose files.</p>
    <input type="file" id="file-input" />
    <button id="read-button">Read File</button>
    <div id="dose-viewer-container">
      <span id="axis-slider-container">
        <form>
          <input type="radio" id="xy" name="axis" value="xy" checked />
          <label for="xy">xy</label>
          <input type="radio" id="yz" name="axis" value="yz" />
          <label for="yz">yz</label>
          <input type="radio" id="xz" name="axis" value="xz" />
          <label for="xz">xz</label>
        </form>
        <div class="slider-container">
          <label for="slice-number"
            >Slice Number:
            <output type="text" id="slider-value" value="">0</output>
          </label>
          <br />
          <output type="text" id="slider-min" value="">0</output>
          <input
            type="range"
            id="slider-range"
            min="0"
            value="0"
            class="slider"
            disabled
          />
          <output type="text" id="slider-max" value=""></output>
          <button id="decrement-slider">-</button>
          <button id="increment-slider">+</button>
        </div>
      </span>
      <span id="voxel-info">
        <p>World Coordinates</p>
        <label for="world-x-value"
          >x:
          <output type="text" id="world-x-value" value=""> </output>
        </label>
        <label for="world-y-value"
          >y:
          <output type="text" id="world-y-value" value=""> </output>
        </label>
        <label for="world-z-value"
          >z:
          <output type="text" id="world-z-value" value=""> </output>
        </label>
        <p>Voxel Coordinates</p>
        <label for="voxel-x-value"
          >x:
          <output type="text" id="voxel-x-value" value=""> </output>
        </label>
        <label for="voxel-y-value"
          >y:
          <output type="text" id="voxel-y-value" value=""> </output>
        </label>
        <label for="voxel-z-value"
          >z:
          <output type="text" id="voxel-z-value" value=""> </output>
        </label>
        <p>Data at Coordinates</p>
        <label for="density-value"
          >Density:
          <output type="text" id="density-value" value=""> </output>
        </label>
        <label for="dose-value"
          >Dose:
          <output type="text" id="dose-value" value=""> </output>
        </label>
      </span>
      <div id="chartholder">
        <svg id="axis-svg" class="plot"></svg>
        <svg id="plot-density" class="plot"></svg>
        <svg id="plot-dose" class="plot"></svg>
        <svg id="plot-marker" class="plot"></svg>
        <div id="legendholder">
          <svg id="dose-legend-svg" class="legend"></svg>
          <svg id="density-legend-svg" class="legend"></svg>
        </div>
      </div>
    </div>
    <div id="dose-profile-viewer">
      <p>
        Select axis and voxel coordinates to view and compare dose profiles.
      </p>
      <form>
        <input type="radio" id="x" name="profile-axis" value="x" checked />
        <label for="x">x</label>
        <input type="radio" id="y" name="profile-axis" value="y" />
        <label for="y">y</label>
        <input type="radio" id="z" name="profile-axis" value="z" />
        <label for="z">z</label>
      </form>
      <form>
        <label>
          <span id="coord-1-label">y:</span>
          <input
            type="number"
            id="coord-1"
            name="coord-input"
            autocomplete="off"
            min="0"
            step="1"
            value="0"
            disabled
          />
        </label>
        <br />
        <label>
          <span id="coord-2-label">z:</span>
          <input
            type="number"
            id="coord-2"
            name="coord-input"
            autocomplete="off"
            min="0"
            step="1"
            value="0"
            disabled
          />
        </label>
      </form>
      <button id="dose-profile-button">Make Dose Profile</button>
      <svg id="dose-profile-svg" class="plot"></svg>
    </div>
    <script type="text/javascript" src="./create-volume.js"></script>
    <script>
      // TODO: Make a dose-view options class?
      // TODO: Move all javascript outside of index.html
      // TODO: Make plotting object? Define all variables there

      // Define all size variables
      var fullWidth = 500;
      var fullHeight = 500;
      var margin = { top: 10, right: 20, bottom: 30, left: 40 };
      var width = fullWidth - margin.left - margin.right;
      var height = fullHeight - margin.top - margin.bottom;

      // Define legend size variables
      // From https://bl.ocks.org/starcalibre/6cccfa843ed254aa0a0d
      var legendFullHeight = fullHeight;
      var legendFullWidth = 100;
      var legendMargin = { top: 30, bottom: 20, left: 10, right: 5 };
      var legendWidth =
        legendFullWidth - legendMargin.left - legendMargin.right;
      var legendHeight =
        legendFullHeight - legendMargin.top - legendMargin.bottom;

      //var sliceNum = d3.select("#slider-value").node().value;
      var axis = d3.selectAll("input[name='axis']:checked").node().value;
      var plotCoords;

      var svgDose = d3
        .select("#plot-dose")
        .attr("width", width)
        .attr("height", height)
        .style(
          "transform",
          "translate(" + margin.left + "px" + "," + margin.top + "px" + ")"
        );

      var svgDensity = d3
        .select("#plot-density")
        .attr("width", width)
        .attr("height", height)
        .style(
          "transform",
          "translate(" + margin.left + "px" + "," + margin.top + "px" + ")"
        );

      var svgAxis = d3
        .select("#axis-svg")
        .attr("width", fullWidth)
        .attr("height", fullHeight)
        .append("g")
        .style(
          "transform",
          "translate(" + margin.left + "px" + "," + margin.top + "px" + ")"
        );

      var svgMarker = d3
        .select("#plot-marker")
        .attr("width", width)
        .attr("height", height)
        .style(
          "transform",
          "translate(" + margin.left + "px" + "," + margin.top + "px" + ")"
        );

      var doseLegendSvg = d3
        .select("#dose-legend-svg")
        .attr("width", legendFullWidth)
        .attr("height", legendFullHeight / 2)
        .style("padding-left", fullWidth)
        .style(
          "transform",
          "translate(" +
            legendMargin.left +
            "px" +
            "," +
            legendMargin.top +
            "px" +
            ")"
        );

      var densityLegendSvg = d3
        .select("#density-legend-svg")
        .attr("width", legendFullWidth)
        .attr("height", legendFullHeight / 2)
        .style("padding-left", fullWidth)
        .style(
          "transform",
          "translate(" +
            legendMargin.left +
            "px" +
            "," +
            legendMargin.top +
            "px" +
            ")"
        );

      //TODO: Make a list of volumes rather than have one global
      const densityVol = new DensityVolume(height, width);
      const doseVol = new DoseVolume(height, width);
      var zoomTransform;

      //TODO: Disable until data is uploaded
      // Zooming functionality
      svgMarker.call(
        d3
          .zoom()
          .extent([
            [0, 0],
            [width, height],
          ])
          .scaleExtent([1, 6])
          .on("zoom", () => zoomedAll(d3.event.transform))
      );

      function zoomedAll(transform) {
        if (!densityVol.isEmpty() || !doseVol.isEmpty()) {
          zoomTransform = transform;
          let gDensity = svgDensity.select("g.density-contour");
          svgDensity
            .select("g.density-contour")
            .attr("transform", transform.toString());

          svgDose
            .select("g.dose-contour")
            .attr("transform", transform.toString());

          svgMarker.select(".marker").attr("transform", transform.toString());

          // create new scale ojects based on event
          let vol = !densityVol.isEmpty() ? densityVol : doseVol;
          var new_xScale = transform.rescaleX(vol.prevSlice.xScale);
          var new_yScale = transform.rescaleY(vol.prevSlice.yScale);

          // update axes
          svgAxis.select(".x-axis").call(d3.axisBottom().scale(new_xScale));
          svgAxis.select(".y-axis").call(d3.axisLeft().scale(new_yScale));
        }
      }
    </script>
    <script type="text/javascript" src="./slider.js"></script>
    <script type="text/javascript" src="./voxel-coordinates.js"></script>
    <script type="text/javascript" src="./read-data.js"></script>
    <script type="text/javascript" src="./dose-profile.js"></script>
  </body>
</html>
