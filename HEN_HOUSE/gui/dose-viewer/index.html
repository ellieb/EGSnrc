<!DOCTYPE html>
<html>
  <head>
    <title>Dose Viewer</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://x3dom.org/download/dev/x3dom-full.js"></script>
    <link rel="stylesheet" href="https://x3dom.org/release/x3dom.css" />
    <link rel="stylesheet" href="styles.css" />
    <script src="https://raw.githack.com/jamesleesaunders/d3-x3d/master/dist/d3-x3d.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.js"></script>
    <script async src="http://cdn.jsdelivr.net/g/filesaver.js"></script>
    <script
      async
      src="http://html2canvas.hertzen.com/dist/html2canvas.js"
    ></script>
    <script
      async
      src="https://unpkg.com/computed-style-to-inline-style"
    ></script>
  </head>
  <body>
    <h1>Dose Viewer</h1>
    <p class="description">Upload .egsphant and .3ddose files.</p>
    <div id="drop-area">
      <form class="file-upload">
        <p>
          Drop or select one or more .egsphant and .3ddose files.
        </p>
        <input
          type="file"
          id="file-input"
          multiple
          accept=".egsphant, .3ddose"
        />
        <br />
        <progress
          id="progress-bar"
          max="100"
          value="0"
          class="hidden"
        ></progress>
      </form>
    </div>
    <div id="dose-viewer-container" class="container">
      <span id="dose-viewer-info-container" class="container">
        <div id="axis-slider-container">
          <form>
            <input type="radio" id="xy" name="axis" value="xy" checked />
            <label for="xy">xy</label>
            <input type="radio" id="yz" name="axis" value="yz" />
            <label for="yz">yz</label>
            <input type="radio" id="xz" name="axis" value="xz" />
            <label for="xz">xz</label>
          </form>
          <div class="slider-container">
            <label for="slice-number"
              >Slice Number:
              <output type="text" id="slider-value" value="">0</output>
            </label>
            <br />
            <output type="text" id="slider-min" value="">0</output>
            <input
              type="range"
              id="slider-range"
              min="0"
              value="0"
              class="slider"
              disabled
            />
            <output type="text" id="slider-max" value=""></output>
            <button id="decrement-slider">-</button>
            <button id="increment-slider">+</button>
          </div>
          <div class="slider-container">
            <label for="max-dose"
              >Max Dose:
              <output type="text" id="max-dose-slider-value" value="">0</output>
            </label>
            <br />
            <output type="text" id="max-dose-slider-min" value=""></output>
            <input
              type="range"
              id="max-dose-slider-range"
              min="0"
              value="0"
              class="slider"
              disabled
            />
            <output type="text" id="max-dose-slider-max" value=""></output>
            <button id="max-dose-decrement-slider">-</button>
            <button id="max-dose-increment-slider">+</button>
          </div>
          <div class="window-level-container">
            <label for="window">Window:</label>
            <input type="range" class="window-slider" name="window" />
            <output type="text" id="window-value" value="">0</output>
            <br />
            <label for="level">Level:</label>
            <input type="range" class="level-slider" name="level" />
            <output type="text" id="level-value" value="">0</output>
          </div>
        </div>
      </span>
      <span id="voxel-info" class="container hidden">
        <p>World Coordinates (cm)</p>
        <label for="world-x-value"
          >x:
          <output
            type="text"
            class="voxel-info-output"
            id="world-x-value"
            value=""
          >
          </output>
        </label>
        <label for="world-y-value"
          >y:
          <output
            type="text"
            class="voxel-info-output"
            id="world-y-value"
            value=""
          >
          </output>
        </label>
        <label for="world-z-value"
          >z:
          <output
            type="text"
            class="voxel-info-output"
            id="world-z-value"
            value=""
          >
          </output>
        </label>
        <p>Voxel Coordinates</p>
        <label for="voxel-x-value"
          >x:
          <output
            type="text"
            class="voxel-info-output"
            id="voxel-x-value"
            value=""
          >
          </output>
        </label>
        <label for="voxel-y-value"
          >y:
          <output
            type="text"
            class="voxel-info-output"
            id="voxel-y-value"
            value=""
          >
          </output>
        </label>
        <label for="voxel-z-value"
          >z:
          <output
            type="text"
            class="voxel-info-output"
            id="voxel-z-value"
            value=""
          >
          </output>
        </label>
        <p>Data at Coordinates</p>
        <label for="density-value"
          >Density:
          <output
            type="text"
            class="voxel-info-output"
            id="density-value"
            value=""
          >
          </output>
        </label>
        <br />
        <label for="material-value"
          >Material:
          <output
            type="text"
            class="voxel-info-output"
            id="material-value"
            value=""
          >
          </output>
        </label>
        <br />
        <label for="dose-value"
          >Dose:
          <output
            type="text"
            class="voxel-info-output"
            id="dose-value"
            value=""
          >
          </output>
        </label>
      </span>
      <span class="container">
        <button id="save-vis" disabled>Export visualization to PNG</button>
        <br />
        <button id="save-dose-profile" disabled>
          Export dose profiles to CSV
        </button>
        <br />
        <input
          type="checkbox"
          id="show-marker-checkbox"
          name="show-marker-checkbox"
          value="ShowMarker"
          disabled
        />
        <label for="show-marker-checkbox">
          Show voxel information on click?
        </label>
        <br />
        <br />
        <input
          type="checkbox"
          id="show-dose-profile-checkbox"
          name="show-dose-profile-checkbox"
          value="ShowDoseProfile"
          disabled
        />
        <label for="show-dose-profile-checkbox">
          Plot dose profile at crosshairs?
        </label>
        <br />
      </span>
      <div id="image-to-print">
        <span id="viewer-container" class="container"> </span>
        <span id="legendholder" class="legend-holder"> </span>
        <span id="dose-profile-holder" class="container">
          <svg id="dose-profile-svg-x" class="dose-profile-plot"></svg>
          <svg id="dose-profile-svg-y" class="dose-profile-plot"></svg>
        </span>
      </div>
    </div>
    <div id="dose-profile-viewer" style="display: none;">
      <p>
        Select axis and voxel coordinates to view and compare dose profiles.
      </p>
      <form>
        <input
          type="radio"
          id="x"
          name="profile-axis"
          value="x"
          checked
          disabled
        />
        <label for="x">x</label>
        <input type="radio" id="y" name="profile-axis" value="y" disabled />
        <label for="y">y</label>
        <input type="radio" id="z" name="profile-axis" value="z" disabled />
        <label for="z">z</label>
      </form>
      <form>
        <label>
          <span id="coord-1-label">y:</span>
          <input
            type="number"
            id="coord-1"
            name="coord-input"
            autocomplete="off"
            min="0"
            step="1"
            value="0"
            disabled
          />
        </label>
        <br />
        <label>
          <span id="coord-2-label">z:</span>
          <input
            type="number"
            id="coord-2"
            name="coord-input"
            autocomplete="off"
            min="0"
            step="1"
            value="0"
            disabled
          />
        </label>
        <input
          type="checkbox"
          id="density-profile-checkbox"
          name="density-profile-checkbox"
          value="PlotDensity"
          disabled
        />
        <label for="density-profile-checkbox"> Plot density? </label>
      </form>
      <button id="dose-profile-button" disabled>Make Dose Profile</button>
      <svg id="dose-profile-svg" class="plot"></svg>
    </div>
    <script type="text/javascript" src="./create-volume.js"></script>
    <script type="text/javascript" src="./dose-profile.js"></script>
    <script type="text/javascript" src="./zoom.js"></script>
    <script type="text/javascript" src="./panel.js"></script>
    <script>
      // TODO: Make a dose-view options class?
      // TODO: Move all javascript outside of index.html
      // TODO: Make plotting object? Define all variables there
      // TODO: Make size variables objects

      // Define all size variables
      let mainViewerDimensions = {
        fullWidth: 320,
        fullHeight: 300,
        margin: { top: 10, right: 20, bottom: 50, left: 60 },
        get width() {
          return this.fullWidth - this.margin.left - this.margin.right;
        },
        get height() {
          return this.fullHeight - this.margin.top - this.margin.bottom;
        },
      };

      // Define legend size variables
      // From https://bl.ocks.org/starcalibre/6cccfa843ed254aa0a0d
      let legendDimensions = {
        fullWidth: 80,
        fullHeight: mainViewerDimensions.fullHeight,
        margin: { top: 25, bottom: 5, left: 10, right: 5 },
        get width() {
          return this.fullWidth - this.margin.left - this.margin.right;
        },
        get height() {
          return this.fullHeight - this.margin.top - this.margin.bottom;
        },
      };

      // Define profile dose size variables
      let sideDoseProfileDimensions = {
        fullWidth: 400,
        fullHeight: mainViewerDimensions.fullHeight / 2,
        margin: { top: 30, right: 30, bottom: 50, left: 70 },
        get width() {
          return this.fullWidth - this.margin.left - this.margin.right;
        },
        get height() {
          return this.fullHeight - this.margin.top - this.margin.bottom;
        },
      };

      // TODO: var makePanels = () => {}; in volume?
      // For each axis and plot class, make html
      let axes = ["xy", "yz", "xz"];
      let classes = ["axis-svg", "plot-density", "plot-dose", "plot-marker"];
      let type = ["svg", "canvas", "svg", "svg"];
      let svgObjs = {
        "axis-svg": {},
        "plot-density": {},
        "plot-dose": {},
        "plot-marker": {},
      };

      // TODO: Just make one object
      let axisObjs = {
        xy: {},
        yz: {},
        xz: {},
      };

      axes.forEach((axis) => {
        let selectedDiv = d3
          .select("#viewer-container")
          .append("div")
          .classed("imageholder-" + axis, true)
          .classed("parent", true);

        classes.forEach((className, i) => {
          let layerNum = i + 1;
          let plot = selectedDiv
            .append("div")
            .classed("layer-" + layerNum, true)
            .style("z-index", layerNum)
            .append(type[i])
            .classed(className, true)
            .classed(axis, true)
            .classed("plot", true)
            .attr("width", mainViewerDimensions.width)
            .attr("height", mainViewerDimensions.height);

          svgObjs[className][axis] = plot;
          axisObjs[axis][className] = plot;
        });
      });

      // Initialize dose and density legend
      var getMarginStr = (margin) =>
        margin.top +
        "px " +
        margin.right +
        "px " +
        margin.bottom +
        "px " +
        margin.left +
        "px";

      var getLegendHolderAndSvg = (parentDiv, className) => {
        let legendHolder = parentDiv
          .append("span")
          .attr("id", className + "-legend-holder")
          .style("width", legendDimensions.width + "px")
          .style("height", legendDimensions.height + "px")
          .style("margin", getMarginStr(legendDimensions.margin));

        let legendSvg = legendHolder
          .append("svg")
          .attr("id", className + "-legend-svg")
          .attr("class", "legend");

        return [legendHolder, legendSvg];
      };

      let selectedDiv = d3.select("#legendholder");
      let [doseLegendHolder, doseLegendSvg] = getLegendHolderAndSvg(
        selectedDiv,
        "dose"
      );
      let [densityLegendHolder, densityLegendSvg] = getLegendHolderAndSvg(
        selectedDiv,
        "density"
      );

      var svgMarker = d3.select("#viewer-container");
      var svgMarkers = svgObjs["plot-marker"];

      // // Add black background to plot
      // canvDensity
      //   .append("rect")
      //   .attr("width", mainViewerDimensions.width)
      //   .attr("height", mainViewerDimensions.height)
      //   .attr("fill", "rgba(225,225,225,0.5)");

      var svgAxis = d3
        .select("#axis-svg")
        .attr("width", mainViewerDimensions.fullWidth)
        .attr("height", mainViewerDimensions.fullHeight)
        .append("g")
        .style(
          "transform",
          "translate(" +
            mainViewerDimensions.margin.left +
            "px" +
            "," +
            mainViewerDimensions.margin.top +
            "px" +
            ")"
        );

      var axis = d3.selectAll("input[name='axis']:checked").node().value;
      var plotCoords;
      var zoomTransform;

      // Initializing svgs for dose profile plots
      var doseProfileXSvg = d3
        .select("#dose-profile-svg-x")
        .attr("width", sideDoseProfileDimensions.fullWidth)
        .attr("height", sideDoseProfileDimensions.fullHeight)
        .append("g")
        .style(
          "transform",
          "translate(" +
            sideDoseProfileDimensions.margin.left +
            "px" +
            "," +
            sideDoseProfileDimensions.margin.top +
            "px" +
            ")"
        );

      var doseProfileYSvg = d3
        .select("#dose-profile-svg-y")
        .attr("width", sideDoseProfileDimensions.fullWidth)
        .attr("height", sideDoseProfileDimensions.fullHeight)
        .append("g")
        .style(
          "transform",
          "translate(" +
            sideDoseProfileDimensions.margin.left +
            "px" +
            "," +
            sideDoseProfileDimensions.margin.top +
            "px" +
            ")"
        );

      // Create box to capture mouse events
      var doseProfileBoxX = doseProfileXSvg
        .append("rect")
        .attr("width", sideDoseProfileDimensions.width)
        .attr("height", sideDoseProfileDimensions.height)
        .attr("fill", "white")
        .attr("class", "bounding-box");

      var doseProfileBoxY = doseProfileYSvg
        .append("rect")
        .attr("width", sideDoseProfileDimensions.width)
        .attr("height", sideDoseProfileDimensions.height)
        .attr("fill", "white")
        .attr("class", "bounding-box");

      // Create clip path to bound output after zooming
      doseProfileXSvg
        .append("defs")
        .append("clipPath")
        .attr("id", "clip-x")
        .append("rect")
        .attr("width", sideDoseProfileDimensions.width)
        .attr("height", sideDoseProfileDimensions.height);

      doseProfileYSvg
        .append("defs")
        .append("clipPath")
        .attr("id", "clip-y")
        .append("rect")
        .attr("width", sideDoseProfileDimensions.width)
        .attr("height", sideDoseProfileDimensions.height);

      //TODO: Make a list of volumes rather than have one global
      const densityVol = new DensityVolume(
        mainViewerDimensions,
        legendDimensions,
        svgObjs["plot-density"],
        densityLegendHolder,
        densityLegendSvg
      );
      const doseVol = new DoseVolume(
        mainViewerDimensions,
        legendDimensions,
        svgObjs["plot-dose"],
        doseLegendHolder,
        doseLegendSvg
      );

      // Set up marker coord change event
      var dispatch = d3.dispatch("markerchange");

      var panels = axes.reduce((obj, axis, i) => {
        return {
          ...obj,
          [axis]: new Panel(
            mainViewerDimensions,
            densityVol,
            doseVol,
            axis,
            axisObjs[axis]
          ),
        };
      }, {});

      dispatch.on("markerchange.panels", function (d) {
        Object.values(panels).forEach((panel) => {
          if (panel.axis !== d.panel.axis) {
            let sliceNum, voxelNums;
            if (panel.axis === "xy") {
              sliceNum = d.voxelCoords[2];
              voxelNums = [d.voxelCoords[0], d.voxelCoords[1]];
            } else if (panel.axis === "yz") {
              sliceNum = d.voxelCoords[0];
              voxelNums = [d.voxelCoords[1], d.voxelCoords[2]];
            } else {
              sliceNum = d.voxelCoords[1];
              voxelNums = [d.voxelCoords[0], d.voxelCoords[2]];
            }

            // Convert voxel number to pixel value for both x and y coordinates
            let xScale, yScale;
            if (panel.zoomTransform) {
              xScale = panel.zoomTransform.rescaleX(
                panel.volume.prevSlice[panel.axis].contourXScale
              );
              yScale = panel.zoomTransform.rescaleY(
                panel.volume.prevSlice[panel.axis].contourYScale
              );
            } else {
              xScale = panel.volume.prevSlice[panel.axis].contourXScale;
              yScale = panel.volume.prevSlice[panel.axis].contourYScale;
            }

            let coords = [
              Math.ceil(xScale(voxelNums[0])),
              Math.ceil(yScale(voxelNums[1])),
            ];

            panel.updateMarker(coords, false);
            panel.updateSlice(sliceNum);
          }
        });
      });

      dispatch.on("markerchange.voxelinfo", function (d) {
        updateVoxelCoords(
          d.plotCoords,
          d.panel.axis,
          d.panel.sliceNum,
          d.panel.zoomTransform,
          true
        );
      });

      const doseProfileX = new DoseProfile(
        sideDoseProfileDimensions,
        doseProfileXSvg
      );
      const doseProfileY = new DoseProfile(
        sideDoseProfileDimensions,
        doseProfileYSvg
      );

      //TODO: Disable zoom until data is uploaded

      // Zooming for x dose profile
      doseProfileX.zoomObj = getZoom(
        sideDoseProfileDimensions.width,
        sideDoseProfileDimensions.height,
        zoomedDoseProfile,
        [doseProfileX]
      );

      // Zooming for y dose profile
      doseProfileY.zoomObj = getZoom(
        sideDoseProfileDimensions.width,
        sideDoseProfileDimensions.height,
        zoomedDoseProfile,
        [doseProfileY]
      );

      function getSliceNum() {
        return d3.select("#slider-value").node().value;
      }

      function getAxis() {
        return d3.selectAll("input[name='axis']:checked").node().value;
      }
    </script>
    <script type="text/javascript" src="./window-level-slider.js"></script>
    <script type="text/javascript" src="./file-upload.js"></script>
    <script type="text/javascript" src="./export.mjs"></script>
    <script type="text/javascript" src="./slider.js"></script>
    <script type="text/javascript" src="./voxel-coordinates.js"></script>
    <script type="text/javascript" src="./read-data.js"></script>
    <script type="text/javascript" src="./dose-profile-setup.js"></script>
  </body>
</html>
